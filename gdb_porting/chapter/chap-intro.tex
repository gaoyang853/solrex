
\chapter{\texttt{GNU debugger}~介绍}
\label{chap:introduction}

\section{调试器}

调试器是测试和调试计算机程序的一种软件，可以帮助程序员快速地定位程序错误并完成更改和验证。所以在为嵌入式芯片开发工具链时，调试器是不可缺少的一环，一个好的调试器能大幅度减少程序员修改程序错误的工作量，提高程序开发的效率和正确性。

在进行芯片设计和为它开发相应的工具软件的时候，一般情况下调试器的开发是在汇编器、连接器等二进制工具和编译器开发大致完成时进行。因为在编译工具开发初期可以分析二进制文件和使用模拟器对程序的正确性进行验证，但随着测试程序规模的增大和编译优化功能的完善，这时候仅仅靠分析二进制代码这种原始的方法验证程序的正确性已经无法满足程序开发的需要。而且调试器还有一个作用是可以验证编译工具的正确性。因为编译器在编译程序时一般都有调试选项和优化选项，在发布软件的时候会使用优化选项来得到精简的可执行文件，但在开发过程中，一般会使用调试选项来取得更多的调试信息以便寻找错误。使用调试选项时会向可执行文件中插入大量调试信息供调试器使用，所以这些调试信息的正确性只能由调试器进行检验。因此能够快速地为芯片开发一个功能完善行为正确的调试器是保证芯片设计和产业化进度的必要条件。

\section{\texttt{GNU Debugger}}

\texttt{GNU Debugger}，简称为~\texttt{GDB}，是一个功能强大且全面的~\texttt{GNU}~开源调试器。它使用字符界面，可以用来调试~\texttt{C, C++, Pascal, Fortran}~和一些其它语言。它可以根据不同的配置参数，在不同主机上编译生成不同的调试器以支持不同的计算机体系架构和目标文件格式。它支持~\texttt{20}~多家厂商的~\texttt{90}~多种芯片，其中包括~\texttt{Intel, IBM, AMD, ARM, MIPS}~和~{SUN}~等知名厂商的许多主流芯片。在目标文件格式方面，它支持~\texttt{a.out, ECOFF, XCOFF, PE, ELF}~和~\texttt{SOM}~ 等多种目标文件格式，以及~\texttt{STABS, COFF, DWARF, DWARF2}~和~\texttt{SOM}~等多种调试信息格式。

\texttt{GDB}~的当前版本是~\texttt{6.6}~版，官方网址是：~\url{http://sourceware.org/gdb}~，可以从官方网站下载到~\texttt{GDB}~各个版本的源代码和官方使用和开发文档。

\section{移植~\texttt{GDB}~ 的优点}

采用移植~\texttt{GDB}~的方法比从头开始写一个新的调试器有以下一些优点：

(1)采用移植~\texttt{GDB}~的方法可以利用~\texttt{GDB}~中与具体芯片无关的代码，如各种目标文件的支持代码，读取调试信息的代码，设置断点，观察点等相关的代码，还包括~\texttt{GDB}~的机器语言接口~\texttt{(MI, Machine Interface)}~等。这样能大大的减少开发一个新调试器的工作量，而且可以降低开发门槛。因为这样的话调试器开发者只用略微了解其它部分的功能，专注于某个方面的代码，而不用对各个方面的知识都得有很深的了解。

(2)从使用者角度来说，降低学习难度和周期，使用统一的命令接口。在一个计算机体系架构上使用~\texttt{GDB} 与在其它的计算机体系架构上的使用是完全类似的，甚至可以说是基本相同的。这些相同点包括各种调试命令，输出调试信息的格式等。这样能使程序员避免重新学习另外一个开发工具，提高开发效率。而且~\texttt{GDB}~也已经有了广泛的用户基础，并且能和多种集成开发环境~\texttt{(IDE, Intergrated Development Environment)}~集成，例如~\texttt{DDD, Insight}~和当前非常流行的~\texttt{Eclipse}~，这样能够降低程序员的学习门槛，缩短学习周期，也能相应地降低客户公司培训程序员的成本。

(3)~\texttt{GDB}~与~\texttt{GNU}~的其它开发工具，如~\texttt{GNU}~的编译器~\texttt{GCC}、汇编器~\texttt{GAS}、链接器~\texttt{LD}，能够紧密地结合在一起，形成完整的跨平台开发工具链。由于~\texttt{GNU}~标准的开放性，所有人都可以更改软件的源文件，就算在前端使用其它的编译器，比如~\texttt{Open64}~等，只要产生~\texttt{GNU}~能够识别的标准格式中间文件，结合~\texttt{GNU}~工具链的其它工具也可以非常好地完成整个工具链的构建。

(4)由于不需要重新写芯片无关的代码，为一个新的芯片写一个编译器的时间可以大大地缩短。重新编写一个调试器需要一个团队在相当长的时间内完成，而我们的实践表明移植~\texttt{GDB}~则完全可以由一个人在一个半月内完成，如果根据本文的实践经验再进行开发，整个开发工作可以缩短到一至两个星期，节省的时间和成本可以说是显而易见的。

目前，\texttt{GDB}~官方只有两个关键文档：《~\texttt{Debugging with GDB}~ 》\cite{richard}和《 ~\texttt{GDB Internals}~》\cite{john}。前者是~\texttt{GDB}~的使用手册，主要介绍使用~\texttt{GDB}~调试程序的方法；后者是给开发人员作为参考，介绍~\texttt{GDB}~内部工作机制的文档。但是后者的更新不能跟上~\texttt{GDB}~的发展，而且有很多关键章节是空的，所以不能完全依赖它来了解~\texttt{GDB}~所有的内部机制和解决移植~\texttt{GDB}~所遇到的难题。本文是对它的一个补充，着重描述如何基于~\texttt{GDB}~为某种芯片快速开发一个正确和稳定的调试工具。

